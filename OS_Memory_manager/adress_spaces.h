#include "mmemory.h"

/**
	v	- виртуальный
	va	- виртуальный адрес
	vas - виртуальное адресное пространство
	
	p	- физический
	pa	- физический адрес
	pas - физическое адресное пространство
	st	- таблица сегментов
	mem	- физическая память
**/

#ifndef ADRESS_SPACES_H
#define ADRESS_SPACES_H

// Сокращение для unsigned int (не size_t!)
typedef unsigned int uint;

// Тип, описывающий сегмент памяти
typedef struct
{
	VA		starting_va;
	VA		starting_pa;
	size_t	size;
}
segment;

// Минимальный размер физического адресного пространства (в байтах)
#define _PAS_MIN_SIZE (\
	sizeof(segment_table) + sizeof(st_record) * _ST_MAX_RECORDS_COUNT \
	)
#define _PAS_MAX_SIZE 10 * 1024			// Максимальный размер физического адресного пространства (в байтах)
#define _VAS_MAX_SIZE _PAS_MAX_SIZE		// Максимальный размер виртуального адресного пространства (в байтах)
#define _FORBIDDEN_ADRESS_OFFSET -1		// Адрес вне выделенного адресного пространсва

VA*			_pas;						// Физическое адресное пространство
VA*			_vas;						// Виртуальное адресное пространство

size_t		_pas_size;					// Текущий размер физического адресного пространства
size_t		_vas_size;					// Текущий размер виртуального адресного пространства

VA*			_first_free_pa;				// Первый свободный физический адрес 
VA*			_first_free_va;				// Первый свободный виртуальный адрес 

VA*			_last_free_pa;				// Последний свободный физический адрес 
VA*			_last_free_va;				// Последний свободный виртуальный адрес 

int			_init_pas(size_t size);
int			_init_vas(size_t size);

void		_unload_segment (segment* segment);
void		_load_adjacent_segments_into_mem (segment* central_segment);


uint		_adress_abs_offset (VA* space, VA adress);
segment*	_find_segment (VA starting_va);


VA*	_defragment_space(VA* space, VA* last_free_space_adress);
void _clear_space_region(VA* starting_adress, size_t size);

/*
	@func	_shift_space_content_left
	@brief	Сдвиг содержимого адресов пространства влево
*/
void _shift_space_content_left	(
	VA*	starting_adress, 
	VA*	last_free_space_adress, 
	uint offset
	);

VA*	_request_free_space_region	(
	VA* space,
	VA*	last_free_space_adress,
	size_t size
	);

size_t _nulled_space_region_size (VA* space, VA* space_region);
void _print_space(VA* space, size_t adress_offset_limit, const char* space_name);


/**
	@func	_organize_space_for_segment_allocation
	@brief	Поиск места или дефрагментация адр. пространства
**/
int	_organize_space_for_segment_allocation(
	VA* space,
	VA** first_free_space_adress, 
	VA* last_free_space_adress, 
	size_t segment_size
	);

/**
	@func	_init_first_free_adress
	@brief	Инициализация пустого адреса, который будет 
			являться начальным адресом сегмента
**/
int	_init_adress (VA* adress, size_t content_size);

/**
	@func	_allocate_segment
	@brief	Размещение сегмента в адресном пространстве
**/
int	_allocate_segment (VA* allocationg_adress, size_t size);

/**
	@func	_register_segment
	@brief	Добавление информации о сегменте в
			сегментную таблицу
**/
int	_register_segment (segment* segment);

/**
	@func	_renew_first_free_adress
	@brief	Получение адреса первой свободной ячейки
**/
VA* _first_null_content_adress(
	VA* space,
	VA* starting_adress,
	VA* last_free_space_adress
	);

#endif // !ADRESS_SPACES_H
